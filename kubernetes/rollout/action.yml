name: "Kubernetes - Rollout"
description: "Wait for rollout status and rollback on failure"

inputs:
  kube-config:
    description: "Base64 encoded kubeconfig"
    required: true
  namespace:
    description: "Kubernetes namespace"
    required: true
  deployment:
    description: "Kubernetes deployment name"
    required: true
  timeout:
    description: "Rollout timeout in seconds"
    required: false
    default: "300"
  rollback-on-failure:
    description: "Auto rollback on failure"
    required: false
    default: "true"

outputs:
  status:
    description: "Rollout status (success, rolled-back, failed)"
    value: ${{ steps.rollout.outputs.status }}

runs:
  using: "composite"
  steps:
    - uses: azure/setup-kubectl@v3

    - name: Setup kubeconfig
      id: kubeconfig
      shell: bash
      env:
        KUBE_CONFIG_B64: ${{ inputs.kube-config }}
      run: |
        set -euo pipefail

        KUBECONFIG_FILE=$(mktemp /tmp/kubeconfig-XXXXXX)
        echo "::add-mask::$KUBECONFIG_FILE"
        echo "path=$KUBECONFIG_FILE" >> "$GITHUB_OUTPUT"

        echo "$KUBE_CONFIG_B64" | base64 -d > "$KUBECONFIG_FILE"
        chmod 600 "$KUBECONFIG_FILE"

    - name: Rollout
      id: rollout
      shell: bash
      env:
        KUBECONFIG: ${{ steps.kubeconfig.outputs.path }}
        NAMESPACE: ${{ inputs.namespace }}
        DEPLOYMENT: ${{ inputs.deployment }}
        TIMEOUT: ${{ inputs.timeout }}
        ROLLBACK: ${{ inputs.rollback-on-failure }}
      run: |
        set -euo pipefail

        if kubectl rollout status "deployment/$DEPLOYMENT" \
          -n "$NAMESPACE" --timeout="${TIMEOUT}s"; then
          echo "Rollout successful"
          echo "status=success" >> "$GITHUB_OUTPUT"
        elif [ "$ROLLBACK" == "true" ]; then
          echo "::warning::Rollout failed, rolling back..."
          kubectl rollout undo "deployment/$DEPLOYMENT" -n "$NAMESPACE"

          if kubectl rollout status "deployment/$DEPLOYMENT" \
            -n "$NAMESPACE" --timeout="${TIMEOUT}s"; then
            echo "::error::Deployment failed, rolled back to previous version"
            echo "status=rolled-back" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "::error::CRITICAL: Deployment and rollback both failed"
            echo "status=failed" >> "$GITHUB_OUTPUT"
            exit 2
          fi
        else
          echo "::error::Rollout failed"
          echo "status=failed" >> "$GITHUB_OUTPUT"
          exit 1
        fi

    - name: Cleanup kubeconfig
      if: always()
      shell: bash
      env:
        KUBECONFIG_FILE: ${{ steps.kubeconfig.outputs.path }}
      run: rm -f "$KUBECONFIG_FILE"


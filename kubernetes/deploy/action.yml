name: "Kubernetes - Deploy"
description: "Set image on Kubernetes deployment"

inputs:
  kube-config:
    description: "Base64 encoded kubeconfig"
    required: true
  namespace:
    description: "Kubernetes namespace"
    required: true
  deployment:
    description: "Kubernetes deployment name"
    required: true
  image:
    description: "Full image reference (registry/image:tag)"
    required: true

outputs:
  status:
    description: "Deploy status (success, failed)"
    value: ${{ steps.deploy.outputs.status }}

runs:
  using: "composite"
  steps:
    - uses: azure/setup-kubectl@v3

    - name: Setup kubeconfig
      id: kubeconfig
      shell: bash
      env:
        KUBE_CONFIG_B64: ${{ inputs.kube-config }}
      run: |
        set -euo pipefail

        KUBECONFIG_FILE=$(mktemp /tmp/kubeconfig-XXXXXX)
        echo "::add-mask::$KUBECONFIG_FILE"
        echo "path=$KUBECONFIG_FILE" >> "$GITHUB_OUTPUT"

        echo "$KUBE_CONFIG_B64" | base64 -d > "$KUBECONFIG_FILE"
        chmod 600 "$KUBECONFIG_FILE"

    - name: Deploy
      id: deploy
      shell: bash
      env:
        KUBECONFIG: ${{ steps.kubeconfig.outputs.path }}
        NAMESPACE: ${{ inputs.namespace }}
        DEPLOYMENT: ${{ inputs.deployment }}
        IMAGE: ${{ inputs.image }}
      run: |
        set -euo pipefail

        echo "Deploying: $IMAGE"

        if kubectl set image "deployment/$DEPLOYMENT" \
          "$DEPLOYMENT=$IMAGE" \
          -n "$NAMESPACE"; then
          echo "status=success" >> "$GITHUB_OUTPUT"
        else
          echo "status=failed" >> "$GITHUB_OUTPUT"
          echo "::error::Failed to set image on deployment/$DEPLOYMENT"
          exit 1
        fi

    - name: Cleanup kubeconfig
      if: always()
      shell: bash
      env:
        KUBECONFIG_FILE: ${{ steps.kubeconfig.outputs.path }}
      run: rm -f "$KUBECONFIG_FILE"


name: "Docker - Build"
description: "Build and push Docker image with registry caching"

inputs:
  registry:
    description: "Registry host"
    required: true
  username:
    description: "Registry username"
    required: true
  password:
    description: "Registry password"
    required: true
  image:
    description: "Image name (without registry prefix)"
    required: true
  tag:
    description: "Image tag (e.g. v1.2.3, sha-abc123)"
    required: false
    default: ""
  tag-latest:
    description: "Latest tag per environment (e.g. latest, latest-feature, latest-staging)"
    required: false
    default: "latest"
  push-by-digest:
    description: "Push by digest instead of tags"
    required: false
    default: "false"
  context:
    description: "Build context path"
    required: false
    default: "."
  dockerfile:
    description: "Dockerfile path (default: {context}/Dockerfile)"
    required: false
    default: ""
  platforms:
    description: "Target platforms"
    required: false
    default: "linux/amd64"
  build-args:
    description: "Additional build arguments (multiline KEY=VALUE)"
    required: false
    default: ""

outputs:
  digest:
    description: "Image digest"
    value: ${{ steps.result.outputs.digest }}
  image-ref:
    description: "Full image reference"
    value: ${{ steps.result.outputs.image_ref }}

runs:
  using: "composite"
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}

    - name: Resolve tags
      id: tags
      shell: bash
      env:
        REGISTRY: ${{ inputs.registry }}
        IMAGE: ${{ inputs.image }}
        TAG: ${{ inputs.tag }}
        TAG_LATEST: ${{ inputs.tag-latest }}
      run: |
        set -euo pipefail

        TAGS=""
        if [ -n "$TAG" ]; then
          TAGS="${REGISTRY}/${IMAGE}:${TAG}"
        fi
        if [ -n "$TAG_LATEST" ]; then
          [ -n "$TAGS" ] && TAGS="${TAGS},"
          TAGS="${TAGS}${REGISTRY}/${IMAGE}:${TAG_LATEST}"
        fi

        echo "tags=$TAGS" >> "$GITHUB_OUTPUT"

    - name: Build and push (digest)
      if: inputs.push-by-digest == 'true'
      id: digest
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile || format('{0}/Dockerfile', inputs.context) }}
        platforms: ${{ inputs.platforms }}
        push: true
        outputs: type=image,name=${{ inputs.registry }}/${{ inputs.image }},push-by-digest=true
        cache-from: |
          type=registry,ref=${{ inputs.registry }}/${{ inputs.image }}:buildcache
          type=registry,ref=${{ inputs.registry }}/${{ inputs.image }}:${{ inputs.tag-latest }}
        cache-to: |
          type=registry,ref=${{ inputs.registry }}/${{ inputs.image }}:buildcache,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1
          VERSION=${{ github.sha }}
          ${{ inputs.build-args }}
        provenance: false
        sbom: false

    - name: Build and push (tagged)
      if: inputs.push-by-digest != 'true'
      id: tagged
      uses: docker/build-push-action@v5
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile || format('{0}/Dockerfile', inputs.context) }}
        platforms: ${{ inputs.platforms }}
        push: true
        tags: ${{ steps.tags.outputs.tags }}
        cache-from: |
          type=registry,ref=${{ inputs.registry }}/${{ inputs.image }}:buildcache
          type=registry,ref=${{ inputs.registry }}/${{ inputs.image }}:${{ inputs.tag-latest }}
        cache-to: |
          type=registry,ref=${{ inputs.registry }}/${{ inputs.image }}:buildcache,mode=max
          type=registry,ref=${{ inputs.registry }}/${{ inputs.image }}:${{ inputs.tag-latest }},mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1
          VERSION=${{ github.sha }}
          ${{ inputs.build-args }}
        provenance: false
        sbom: false

    - name: Set outputs
      id: result
      shell: bash
      env:
        DIGEST_OUT: ${{ steps.digest.outputs.digest }}
        TAGGED_OUT: ${{ steps.tagged.outputs.digest }}
        REGISTRY: ${{ inputs.registry }}
        IMAGE: ${{ inputs.image }}
        TAG: ${{ inputs.tag }}
        TAG_LATEST: ${{ inputs.tag-latest }}
        PUSH_DIGEST: ${{ inputs.push-by-digest }}
      run: |
        set -euo pipefail

        DIGEST="${DIGEST_OUT:-$TAGGED_OUT}"

        if [ -z "$DIGEST" ]; then
          echo "::error::Build produced no digest"
          exit 1
        fi

        echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

        if [ "$PUSH_DIGEST" == "true" ]; then
          echo "image_ref=${REGISTRY}/${IMAGE}@${DIGEST}" >> "$GITHUB_OUTPUT"
        elif [ -n "$TAG" ]; then
          echo "image_ref=${REGISTRY}/${IMAGE}:${TAG}" >> "$GITHUB_OUTPUT"
        else
          echo "image_ref=${REGISTRY}/${IMAGE}:${TAG_LATEST}" >> "$GITHUB_OUTPUT"
        fi


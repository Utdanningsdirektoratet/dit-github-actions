name: "Docker - Tag"
description: "Tag a Docker image by digest"

inputs:
  registry:
    description: "Registry host"
    required: true
  username:
    description: "Registry username"
    required: true
  password:
    description: "Registry password"
    required: true
  image:
    description: "Image name"
    required: true
  digest:
    description: "Image digest to tag"
    required: true
  tag:
    description: "Version tag (auto-generated if empty)"
    required: false
    default: ""
  tag-latest:
    description: "Latest tag per environment"
    required: false
    default: "latest"

outputs:
  tag:
    description: "Resolved version tag"
    value: ${{ steps.tag.outputs.tag }}
  image-ref:
    description: "Full image reference with version tag"
    value: ${{ steps.tag.outputs.image_ref }}

runs:
  using: "composite"
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to registry
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}

    - name: Tag image
      id: tag
      shell: bash
      run: |
        REGISTRY="${{ inputs.registry }}"
        IMAGE="${{ inputs.image }}"
        DIGEST="${{ inputs.digest }}"
        TAG="${{ inputs.tag }}"
        TAG_LATEST="${{ inputs.tag-latest }}"
        SHORT_SHA="${GITHUB_SHA:0:7}"

        [ -z "$TAG" ] && TAG="$(date -u '+%y%m%d-%H%M%S')_${SHORT_SHA}"

        echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        echo "image_ref=${REGISTRY}/${IMAGE}:${TAG}" >> "$GITHUB_OUTPUT"

        docker buildx imagetools create \
          --tag ${REGISTRY}/${IMAGE}:${TAG} \
          ${REGISTRY}/${IMAGE}@${DIGEST} &

        docker buildx imagetools create \
          --tag ${REGISTRY}/${IMAGE}:${SHORT_SHA} \
          ${REGISTRY}/${IMAGE}@${DIGEST} &

        if [ -n "$TAG_LATEST" ]; then
          docker buildx imagetools create \
            --tag ${REGISTRY}/${IMAGE}:${TAG_LATEST} \
            ${REGISTRY}/${IMAGE}@${DIGEST} &
        fi

        wait
        echo "Tagged: $TAG, $SHORT_SHA, $TAG_LATEST"
